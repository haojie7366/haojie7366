---
title: Windows系统自动还原
date: 2023-07-16 00:02:00
tags:
---
## 一、工作原理
自动还原是划分了三个系统空间，一个空间用于存放系统备份，另外两个空间存放运行的系统。  
1. 开机后，进入系统1，然后将系统备份还原到系统2，并设置下一次进入系统2。  
2. 再次开机后进入系统2，然后将系统备份还原到系统1，并设置下一次进入系统1。  

这样每次开机后都可以进入一个新的系统。
## 二、工具准备  
1. 下载Windows官方镜像  
微软官方Windows10下载地址：  
<https://www.microsoft.com/zh-cn/software-download/windows10>   
微软官方Windows11下载地址：  
<https://www.microsoft.com/zh-cn/software-download/windows11>  
第三方下载地址：<https://next.itellyou.cn/>  
第三方下载的也是官方镜像，需要配合迅雷下载，下载速度比官方镜像更快。
2. Dism++: [点击下载](/images/Dism++.zip)
3. BOOTICE: [点击下载](/images/BOOTICEx64.exe)
4. 延长系统更新时间脚本：[点击下载](/images/延长系统更新时间.reg)
5. 系统还原文件：[点击下载](/images/系统还原.zip)
6. 推荐准备一个U盘，U盘内安装PE系统，在安装过程中出现意外也可以在PE中有修复系统的可能。   
下载微PE：<https://www.wepe.com.cn/download.html>  
![微PE下载](/images/wepe_download.png)
选择最新版本的，下载64位版本，下载完成后打开，安装到U盘。
![微PE安装](/images/wepe_install_U.png)
## 三、安装步骤
1. 准备安装空间，分区内至少有120G的剩余空间。
2. 双击打开BOOTICE-磁盘镜像-创建VHD，输入文件位置和名字，例如`C:\Windows10.vhdx`,推荐复制粘贴，可以将C盘换成其他盘，设置虚拟硬盘的容量为40G。
   ![创建VHD](/images/创建VHD.png)
3. 挂载/卸载VHD-选择刚刚创建的VHD-挂载
4. 此电脑右键-管理-磁盘管理，会弹出虚拟硬盘的初始化磁盘，点确定。
5. 在虚拟硬盘的空白空间内右键-新建简单卷，创建一个新的分区，分区格式为NTFS，记住盘符。
6. 解压缩Dism++,双击里面的Dism++x86，运行程序
7. 文件-释放映像，点第一个浏览，选择Windows系统镜像。
8. 点第二个浏览，选择新建的分区，完成后点确定，开始释放镜像。
    ![释放映像](/images/释放映像D.png)
9.  双击打开BOOTICE，选择BCD编辑—当前系统BCD-智能编辑模式—添加-新建Windows 7/8/8.1启动项
10. 编辑新建的引导，设备类型为VHD(X)，修改启动磁盘和启动分区为虚拟硬盘所在物理磁盘和物理分区，设备文件为`\Windows10.vhdx`，推荐复制粘贴，可以随意修改菜单标题，然后点保存当前系统设置
    ![新建引导](/images/引导-vhd.png)
11. 左侧框内选择新建的引导，设置为默认，超时时间可以设置为3秒，保存全局设置
12. 确认DISM++释放镜像已经成功后，重启电脑。
13. 跟随提示完成系统初始化设置。
14. 解压缩系统还原文件，将解压出来的文件和虚拟硬盘文件放到一起。
    ![系统还原文件](/images/系统还原文件.png)
15. 打开BOOTICE，BCD编辑-其他BCD文件，选择BCDto0，修改引导项Windows10(VHDX)的启动磁盘和启动分区。同样的操作，修改BCDto1和BCDto2。
16. 编辑当前系统BCD，删除新建Windows10(VHDX)引导，重启进入原系统。
17. 进入原本的系统，右键to1，编辑，找到`set dir=C:`将盘符C和to1在当前系统所在的盘符一致，保存。如果保存失败，先另存为到桌面，然后复制替换。
18. 将虚拟硬盘`Windows10.vhdx`，重命名为`Windows10_0.vhdx`推荐复制粘贴，即使安装的系统是Windows8/Windows11，也要重命名为`Windows10_0.vhdx`
19. 运行to1，运行完成后会自动重启电脑。
20. 进入系统后，查看虚拟硬盘所在分区，会多出来一个`Windows10_1.vhdx`的文件，占用空间为40G，说明进入的是该虚拟硬盘中的系统，虚拟硬盘展开占用的全额空间。
21. 编辑to1or2，找到`set dir=E:`将盘符E和to1or2在当前系统所在的盘符一致，保存。如果保存失败，先另存为到桌面，然后复制替换。
22. 运行to1or2，运行成功后手动重启电脑。
23. 进入系统后，查看虚拟硬盘所在分区，会多出来一个`Windows10_2.vhdx`的文件，占用空间为40G，说明进入的是该虚拟硬盘中的系统。
24. 编辑to0，找到`set dir=E:`将盘符E和to0在当前系统所在的盘符一致，保存。如果保存失败，先另存为到桌面，然后复制替换。
25. 运行to0，运行完成后会自动重启电脑。
26. 进入系统后，查看虚拟硬盘所在分区，`Windows10_0.vhdx`的文件，占用空间为40G，说明进入的是该虚拟硬盘中的系统。
27. 搜索更改用户账户控制，改为从不通知。
28. 创建一个文件夹，发送到桌面快捷方式，用于在自动还原系统中，保存需要的文件。
29. 按下WIN+R，调出运行框，输入`shell:startup`，将to1or2脚本复制到弹出的文件夹内。
30. 运行延长系统更新时间，运行完成后，打开设置-Windows更新-高级选项-暂停更新，将系统更新时间设置为最长3000天。
31. 手动重启电脑，进入原本的系统，此时如果不运行其他脚本，就可以一制使用原本的系统。
32. 运行to1，运行完成后会自动重启电脑。进入系统后，查看虚拟硬盘所在分区，`Windows10_1.vhdx`的文件，占用空间为40G，说明进入的是该虚拟硬盘中的系统。
33. 手动重启系统，进入系统后，查看虚拟硬盘所在分区，`Windows10_2.vhdx`的文件，占用空间为40G，说明进入的是该虚拟硬盘中的系统。
34. 从此自动还原安装成功。
## 四、使用方法
1. 从自动还原系统进入原本的系统，运行to0，进入`Windows10_0.vhdx`中的系统，然后重启，进入原系统，如果不运行其他文件，就能保持在原系统。
2. 从原系统进入自动还原系统，运行to1。
3. 在自动还原系统中作持久化操作，运行to0，在这个系统中做的操作可以永久保存，完成操作后，重启电脑进入原系统，运行to1进入自动还原系统。